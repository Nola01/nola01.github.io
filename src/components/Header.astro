---
import { SITE, NAV_LINKS } from "@consts"
import { cn } from "@lib/utils"
import Container from "@components/Container.astro"

const { pathname } = Astro.url;
const lang = pathname.startsWith("/en") ? "en" : "es";
const targetLang = lang === "es" ? "en" : "es";

const isEn = lang === "en";
const currentLinks = NAV_LINKS[lang as keyof typeof NAV_LINKS] || [];
const targetLinks = NAV_LINKS[targetLang as keyof typeof NAV_LINKS] || [];

const cleanPath = pathname.endsWith("/") ? pathname.slice(0, -1) : pathname;
const currentIndex = currentLinks.findIndex(link => link.HREF === cleanPath || link.HREF === pathname);

let toggleLangPath;

if (currentIndex !== -1) {
  toggleLangPath = targetLinks[currentIndex].HREF;
} else {
  if (pathname.includes("/proyectos") || pathname.includes("/projects")) {
    toggleLangPath = lang === "es" 
      ? pathname.replace("/es/proyectos", "/en/projects") 
      : pathname.replace("/en/projects", "/es/proyectos");
  } else if (pathname.includes("/trayectoria") || pathname.includes("/trajectory")) {
    toggleLangPath = lang === "es" 
      ? pathname.replace("/es/trayectoria", "/en/trajectory") 
      : pathname.replace("/en/trajectory", "/es/trayectoria");
  } else {
    toggleLangPath = lang === "es" ? "/en" : "/es";
  }
}

const subpath = pathname.match(/[^/]+/g);
---

<header id="header" transition:name="main-header" class="fixed top-0 w-full h-16 z-50 ">
  <Container size="md">
    <div class="relative h-full w-full">
      <div class="absolute left-0 top-1/2 -translate-y-1/2 flex font-semibold">
        <a href={lang === "es" ? "/es" : "/en"} class="flex items-center gap-1.5 text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
          
          <img 
            src="/code-logo.svg" 
            alt="Logo" 
            class="size-7 dark:invert -mt-0.5" 
          />
          
          <div class="page-heading text-lg tracking-tight">
            {SITE.TITLE}
          </div>
        </a>
      </div>

      <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
        <nav class="hidden md:flex items-center justify-center text-sm gap-1">
          {currentLinks.map((LINK) => {
            const href = LINK.HREF || "/";
            const cleanLink = href.replace(/\/$/, "");
            const cleanCurrent = pathname.replace(/\/$/, "");

            const isActive = cleanCurrent === cleanLink || 
                 (cleanLink.length > 3 && pathname.includes(cleanLink));
                 
            return (
              <a 
                href={href} 
                data-astro-prefetch="hover"
                class={cn(
                  "h-8 rounded-full px-3 text-current flex items-center justify-center transition-colors duration-300 ease-in-out",
                  isActive 
                    ? "bg-black dark:bg-white text-white dark:text-black" 
                    : "hover:bg-black/5 dark:hover:bg-white/20 hover:text-black dark:hover:text-white"
                )}
              >
                {LINK.TEXT}
              </a>
            )
          })}
        </nav>
      </div>

      <div class="buttons absolute right-0 top-1/2 -translate-y-1/2 flex gap-1">
        <a href={toggleLangPath} 
          aria-label="Cambiar idioma" 
          class={cn("hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out text-xs font-bold")}>
          {isEn ? "ES" : "EN"}
        </a>

        <!-- <a href="/search" 
          aria-label={`Buscar en ${SITE.TITLE}`} 
          class={cn("hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out", pathname === "/search" ? "pointer-events-none bg-black dark:bg-white text-white dark:text-black" : "")}>
          <svg class="size-full">
            <use href="/ui.svg#search"></use>
          </svg>
        </a> -->

        <!-- <a href="/rss.xml" 
          target="_blank" 
          aria-label={`Feed RSS de ${SITE.TITLE}`} 
          class={cn("hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out")}>
          <svg class="size-full">
            <use href="/ui.svg#rss"></use>
          </svg>
        </a> -->

        <button id="header-theme-button" 
          aria-label="Cambiar tema" 
          class={cn("hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out")}>
          <svg class="size-full block dark:hidden">
            <use href="/ui.svg#sun"></use>
          </svg>
          <svg class="size-full hidden dark:block">
            <use href="/ui.svg#moon"></use>
          </svg>
        </button>

        <button id="header-drawer-button" 
          aria-label="Abrir menÃº" 
          class={cn("flex md:hidden size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out")}>
          <svg id="drawer-open" class="size-full">
            <use href="/ui.svg#menu"></use>
          </svg>
          <svg id="drawer-close" class="size-full">
            <use href="/ui.svg#x"></use>
          </svg>
        </button>
      </div>
    </div>
  </Container>
</header>